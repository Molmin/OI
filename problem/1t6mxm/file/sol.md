考虑减少状态数目。

记 $f(i,j,0)$ 表示处理到 $a_i$ 满足 $a_{i-1}\leq a_i=j$，且右端点可能情况已计算时的方案数，$f(i,j,1)$ 表示处理到 $a_i$ 满足 $j=a_{i-1}>a_i$，且右端点可能情况未计算时的方案数。

前缀和优化可以做到 $\Theta(n^2)$。